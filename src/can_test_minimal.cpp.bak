#include <Arduino.h>
#include <driver/twai.h>
#include <esp_ota_ops.h>

// CAN pins for Waveshare ESP32-S3 Touch LCD
#define CAN_TX_PIN 19
#define CAN_RX_PIN 20

// Debug output
#define LOG(fmt, ...) Serial.printf("[CAN] " fmt "\n", ##__VA_ARGS__)

void setup() {
    // CRITICAL: Start USB serial FIRST - BEFORE disabling it for CAN
    Serial.begin(115200);
    delay(500);
    
    LOG("=== POWERCELL NGX CAN Test ===");
    LOG("Firmware: Minimal CAN diagnostics");
    
    // Mark OTA as valid immediately
    const esp_partition_t* running = esp_ota_get_running_partition();
    esp_ota_img_states_t ota_state;
    if (esp_ota_get_state_partition(running, &ota_state) == ESP_OK) {
        if (ota_state == ESP_OTA_IMG_PENDING_VERIFY) {
            LOG("OTA firmware verified");
            esp_ota_mark_app_valid_cancel_rollback();
        }
    }

    LOG("Initializing CAN with TX=%d RX=%d", CAN_TX_PIN, CAN_RX_PIN);

    // TWAI (CAN) configuration - 250 kbps for POWERCELL NGX
    twai_general_config_t g_config = TWAI_GENERAL_CONFIG_DEFAULT((gpio_num_t)CAN_TX_PIN, (gpio_num_t)CAN_RX_PIN, TWAI_MODE_NORMAL);
    twai_timing_config_t t_config = TWAI_TIMING_CONFIG_250KBITS();
    twai_filter_config_t f_config = TWAI_FILTER_CONFIG_ACCEPT_ALL();

    if (twai_driver_install(&g_config, &t_config, &f_config) == ESP_OK) {
        LOG("✓ CAN driver installed");
    } else {
        LOG("✗ Failed to install CAN driver");
        return;
    }

    if (twai_start() == ESP_OK) {
        LOG("✓ CAN bus started at 250 kbps");
    } else {
        LOG("✗ Failed to start CAN bus");
        return;
    }

    LOG("Ready to send/receive CAN messages");
    LOG("Listening for POWERCELL NGX responses...");
}

void loop() {
    twai_message_t message;

    // Try to receive a message
    if (twai_receive(&message, pdMS_TO_TICKS(100)) == ESP_OK) {
        LOG("RX ID: 0x%03X DLC: %d Data: %02X %02X %02X %02X %02X %02X %02X %02X",
            message.identifier,
            message.data_length_code,
            message.data[0], message.data[1], message.data[2], message.data[3],
            message.data[4], message.data[5], message.data[6], message.data[7]);
    }

    // Send a POWERCELL NGX polling message every 2 seconds
    static uint32_t last_send = 0;
    if (millis() - last_send > 2000) {
        last_send = millis();

        // Poll POWERCELL at address 1: CAN ID FF41 (0xFF41), source 0x63
        // Message format: 0x11 in first byte, rest zeros
        twai_message_t tx_msg = {};
        tx_msg.identifier = 0xFF41;        // Poll POWERCELL address 1
        tx_msg.data_length_code = 8;
        tx_msg.data[0] = 0x11;             // Poll command
        tx_msg.data[1] = 0;
        tx_msg.data[2] = 0;
        tx_msg.data[3] = 0;
        tx_msg.data[4] = 0;
        tx_msg.data[5] = 0;
        tx_msg.data[6] = 0;
        tx_msg.data[7] = 0;

        if (twai_transmit(&tx_msg, pdMS_TO_TICKS(100)) == ESP_OK) {
            LOG("TX: Poll POWERCELL address 1");
        } else {
            LOG("✗ TX failed");
        }
    }

    delay(10);
}
