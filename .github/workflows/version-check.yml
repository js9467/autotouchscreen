name: Version Consistency Check

on:
  pull_request:
    paths:
      - 'src/version_auto.h'
      - '.version_state.json'
      - 'ota_functions/manifest.json'
  push:
    branches: [main]
    paths:
      - 'src/version_auto.h'
      - '.version_state.json'
      - 'ota_functions/manifest.json'

jobs:
  check-version-consistency:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          # Extract versions from different files
          STATE_VERSION=$(jq -r '"\(.major).\(.minor).\(.build)"' .version_state.json)
          HEADER_VERSION=$(grep -oP 'APP_VERSION = "\K[^"]+' src/version_auto.h)
          MANIFEST_VERSION=$(jq -r '.version' ota_functions/manifest.json)
          
          echo "Version State:    $STATE_VERSION"
          echo "Version Header:   $HEADER_VERSION"
          echo "Manifest Version: $MANIFEST_VERSION"
          
          # Check if version_auto.h matches .version_state.json
          if [ "$HEADER_VERSION" != "$STATE_VERSION" ]; then
            echo "❌ ERROR: version_auto.h ($HEADER_VERSION) does not match .version_state.json ($STATE_VERSION)"
            echo "Run: pio run -e waveshare_7in to regenerate version_auto.h"
            exit 1
          fi
          
          echo "✅ All versions consistent!"
