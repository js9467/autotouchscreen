name: Build Firmware

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'include/**'
      - 'data/**'
      - 'platformio.ini'
      - 'boards/**'
      - 'tools/**'
  workflow_dispatch:

concurrency:
  group: firmware-main
  cancel-in-progress: true

jobs:
  build:
    if: github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio/libdeps
        key: ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-platformio-
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pio --version
    
    - name: Build firmware
      run: pio run -e waveshare_7in
