# AI Agent Instructions for Bronco Controls Project

## CRITICAL: Version Management Rules

**ALL AI AGENTS MUST FOLLOW THESE RULES - NO EXCEPTIONS**

### 1. NEVER Manually Edit These Files:
- `src/version_auto.h` - Only modified by deploy.ps1
- `ota_functions/manifest.json` - Only modified by deploy.ps1  
- `ota_functions/releases/*/manifest.json` - Only modified by deploy.ps1

### 2. ALWAYS Use the Standardized Deployment Script

For ANY code changes that need deployment:

```powershell
# Standard patch version bump
.\deploy.ps1 -Changelog "Description of changes"

# Minor version bump
.\deploy.ps1 -VersionBump minor -Changelog "New feature added"

# Major version bump
.\deploy.ps1 -VersionBump major -Changelog "Breaking changes"

# Local build only (no OTA/git)
.\deploy.ps1 -LocalOnly -Changelog "Local testing"
```

### 3. DO NOT Use PowerShell ConvertTo-Json for Manifests

PowerShell's `ConvertTo-Json` adds extra spaces and formatting that breaks the OTA server JSON parser.

**WRONG:**
```powershell
$manifest | ConvertTo-Json | Out-File manifest.json
```

**CORRECT:**
```powershell
# Use deploy.ps1 script which handles formatting correctly
.\deploy.ps1 -Changelog "Update description"
```

### 4. Workflow for Code Changes

1. Make code changes to source files
2. Test locally if needed: `pio run -e waveshare_7in`
3. Deploy using script: `.\deploy.ps1 -Changelog "What you changed"`
4. The script automatically:
   - Bumps version
   - Builds firmware
   - Creates OTA release
   - Commits to git
   - Pushes to GitHub
   - Deploys to Fly.io

### 5. Emergency Manual Fixes

If you MUST manually fix something:

**For version_auto.h:**
```cpp
#pragma once
// Auto-generated on YYYY-MM-DDTHH:MM:SS.FFFFFFZ
constexpr const char* APP_VERSION = "X.Y.Z";
// MUST have blank line at end
```

**For manifest.json files:**
```json
{
  "version": "X.Y.Z",
  "channel": "stable",
  "changelog": "Description",
  "min_version": "1.0.0",
  "firmware": {
    "url": "https://image-optimizer-still-flower-1282.fly.dev/ota/releases/X.Y.Z/firmware.bin",
    "md5": "hash_here",
    "size": 1234567
  }
}
```

**CRITICAL:** No extra spaces, no trailing commas, UTF-8 encoding, Unix line endings (LF), no BOM

### 6. OTA Update Process

After deployment, trigger update on device:

```powershell
# Check current version
Invoke-RestMethod -Uri "http://192.168.7.116/api/status" | Select firmware_version

# Trigger OTA update
Invoke-RestMethod -Uri "http://192.168.7.116/api/ota/update" -Method POST

# Wait 60 seconds, then verify
Start-Sleep -Seconds 60
Invoke-RestMethod -Uri "http://192.168.7.116/api/status" | Select firmware_version
```

### 7. USB Upload (If OTA Fails)

```powershell
# Find COM port (check Device Manager)
[System.IO.Ports.SerialPort]::GetPortNames()

# Upload
pio run -e waveshare_7in --target upload --upload-port COMX
```

### 8. Common Mistakes to Avoid

❌ **DON'T:**
- Edit version_auto.h directly
- Use `ConvertTo-Json` for manifests
- Create manifest.json with PowerShell hashtables
- Commit version changes without building firmware
- Skip the deploy.ps1 script "just this once"
- Add extra closing braces to JSON files
- Use Windows line endings (CRLF) in JSON files

✅ **DO:**
- Always use deploy.ps1
- Include meaningful changelog messages
- Test locally before deploying to OTA
- Verify deployment completed successfully
- Check device updated to new version

### 9. Quick Reference

| Task | Command |
|------|---------|
| Deploy patch update | `.\deploy.ps1 -Changelog "Fix bug X"` |
| Deploy new feature | `.\deploy.ps1 -VersionBump minor -Changelog "Add feature Y"` |
| Build only (no deploy) | `.\deploy.ps1 -SkipOTA -SkipGit` |
| Local test build | `pio run -e waveshare_7in` |
| Check OTA manifest | `Invoke-RestMethod 'https://image-optimizer-still-flower-1282.fly.dev/ota/manifest'` |
| Trigger device update | `Invoke-RestMethod 'http://192.168.7.116/api/ota/update' -Method POST` |

### 10. Debugging Failed Deployments

If deployment fails:

1. **Check manifest format:**
   ```powershell
   Get-Content ota_functions/releases/X.Y.Z/manifest.json | ConvertFrom-Json
   ```

2. **Verify on Fly.io:**
   ```powershell
   flyctl ssh console -a image-optimizer-still-flower-1282 -C "cat /app/releases/X.Y.Z/manifest.json"
   ```

3. **Check server logs:**
   ```powershell
   flyctl logs -a image-optimizer-still-flower-1282
   ```

4. **Force redeploy:**
   ```powershell
   cd ota_functions
   flyctl deploy --remote-only -a image-optimizer-still-flower-1282
   ```

## Project-Specific Notes

- **CAN Testing:** Use `/api/can/send` endpoint to send J1939 frames
- **InfinityBox:** Test with `test_infinitybox.ps1` script
- **Device IP:** Default is 192.168.7.116 (update if changed)
- **OTA Server:** Hosted on Fly.io at image-optimizer-still-flower-1282.fly.dev

## Summary

**The Golden Rule:** If it involves versioning or deployment, use `deploy.ps1`. Period.

This prevents:
- Version mismatches
- Broken OTA manifests
- Git conflicts
- Manual editing errors
- Inconsistent deployments

Follow these rules and deployments will be smooth and predictable.
